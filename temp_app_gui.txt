// main/app_gui.c
#include "app_gui.h"
#include "display_hal.h"

#include "lvgl.h"
#include "esp_log.h"
#include "esp_err.h"
#include "esp_timer.h"

#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/semphr.h"

#include "ml_window.h"    // ml_get_latest_result()
#include "app_sdcard.h"   

#include <string.h>
#include <stdio.h>

static const char *TAG = "app_gui";
static display_hal_t s_hal;
static esp_lcd_panel_handle_t s_panel_handle = NULL;
static bool s_screen_on = true;

#define GUI_UPDATE_MS  200   // æ¯?200ms åˆ·ä¸€æ¬¡æ–‡æ¡?

/* è‹¥å·¥ç¨‹é‡Œæ²¡å®žçŽ?app_ml_get_latestï¼Œè¿™ä¸ªå¼±ç¬¦å·ä¼šç”Ÿæ•ˆï¼Œè¿”å›ž falseã€‚ä¸€æ—¦åœ¨ app_sdcard.c é‡Œæä¾›äº†çœŸæ­£çš„å®žçŽ°ï¼Œè¿™é‡Œä¼šè¢«è‡ªåŠ¨è¦†ç›–ã€?*/
__attribute__((weak)) bool app_ml_get_latest(ml_result_t *out) {
    (void)out; return false;
}

/* è‹?lv_conf.h å¯ç”¨äº?20 å·å­—ï¼Œè¿™é‡Œå£°æ˜Žå®ƒï¼ˆæ–‡ä»¶ä½œç”¨åŸŸï¼Œé¿å…å‡½æ•°å†…å‘Šè­¦ï¼?*/
#if LV_FONT_MONTSERRAT_20
LV_FONT_DECLARE(lv_font_montserrat_20);
#endif

/* ---------- LVGL tickï¼ˆv9 è¦æ±‚â€œè¿”å›žæ¯«ç§’â€ï¼‰ ---------- */
static uint32_t lv_tick_cb(void)
{
    return (uint32_t)(esp_timer_get_time() / 1000ULL);
}

/* ---------- åˆ·æ–°å›žè°ƒï¼šæŠŠ px_map åŒºåŸŸåˆ·åˆ°é¢æ¿ ---------- */
static void flush_cb(lv_display_t *disp, const lv_area_t *area, uint8_t *px_map)
{
    if (s_hal.trans_done) (void)xSemaphoreTake(s_hal.trans_done, 0);

    esp_err_t e = esp_lcd_panel_draw_bitmap(
        s_hal.panel,
        area->x1, area->y1,
        area->x2 + 1, area->y2 + 1,     //  +1ï¼ˆå³ä¸‹è§’å¼€åŒºé—´ï¼?
        px_map                          //  RGB888ï¼?B/åƒç´ ï¼Œè¯•è¿‡rgb5xxä¼šä¹±ç ?
    );

    if (e == ESP_OK && s_hal.trans_done) {
        (void)xSemaphoreTake(s_hal.trans_done, portMAX_DELAY);
    } else if (e != ESP_OK) {
        ESP_LOGE(TAG, "draw_bitmap failed: %d", (int)e);
    }

    lv_display_flush_ready(disp);
}

/* ---------- åªâ€œå–å€¼å¹¶æ‹¼æ–‡æœ¬â€ï¼Œä¸æ“ä½?UI ---------- */
static void build_text_from_ml(char *out, size_t out_sz)
{
    ml_result_t r;
    bool ok = app_ml_get_latest(&r);     // ä¼˜å…ˆå¿«ç…§ï¼ˆéžæ¶ˆè€—åž‹ï¼?
    if (!ok) ok = ml_get_latest_result(&r); // å›žé€€

    if (ok) {
        const char *mode = (r.pred == 0) ? "walk" : "ebike";
        snprintf(out, out_sz, "%s", mode);   // â†?åªæ˜¾ç¤?walk/ebike
    } else {
        snprintf(out, out_sz, "Waiting for model");
    }
}

/* ---------- GUI ä»»åŠ¡ï¼ˆå”¯ä¸€åœ°æ–¹è°ƒç”¨ lv_label_set_textï¼?---------- */
static void gui_task(void *arg)
{
    ESP_LOGI(TAG, "GUI task start");

    // 1) åˆå§‹åŒ–åº•å±‚æ˜¾ç¤?
    esp_err_t err = display_hal_init(&s_hal);
    if (err != ESP_OK) {
        ESP_LOGE(TAG, "display_hal_init failed: %d", (int)err);
        vTaskDelete(NULL);
        return;
    }

    // 2) åˆå§‹åŒ?LVGL & tick
    lv_init();
    lv_tick_set_cb(lv_tick_cb);

    // 3) åˆ›å»º display â€”â€?ä¿æŒ RGB888ï¼? å­—èŠ‚/åƒç´ ï¼?
    lv_display_t *disp = lv_display_create(s_hal.hor_res, s_hal.ver_res);
    lv_display_set_color_format(disp, LV_COLOR_FORMAT_RGB888);

    // 4) é…ç½®è¡Œç¼“å†²ï¼ˆæ ¼å¼ä¹Ÿç”¨ RGB888ï¼?
    const uint32_t line_cnt = 24;   // 24 è¡Œç¼“å†²ï¼Œå¸¦å®½ä¸Žå†…å­˜çš„æŠ˜ä¸­
    lv_draw_buf_t *dbuf1 = lv_draw_buf_create(
        s_hal.hor_res, line_cnt, LV_COLOR_FORMAT_RGB888, 0
    );
    lv_display_set_draw_buffers(disp, dbuf1, NULL);

    // 5) åˆ·æ–°å›žè°ƒ
    lv_display_set_flush_cb(disp, flush_cb);

    // 6) é»‘åº• + ç™½å­—ï¼›å½»åº•â€œéžæ–œä½“â€ï¼Œå¹¶ä¿è¯çœŸæ­£å±…ä¸?
    lv_obj_set_style_bg_color(lv_screen_active(), lv_color_black(), 0);

    lv_obj_t *label = lv_label_create(lv_screen_active());
    lv_obj_set_style_text_color(label, lv_color_white(), 0);
    lv_obj_set_style_text_align(label, LV_TEXT_ALIGN_CENTER, 0);

    // è®?Label å®½åº¦ = æ•´å±å®½ï¼Œâ€œå±…ä¸­â€æœ‰å‚ç…§
    lv_obj_set_width(label, s_hal.hor_res);
    lv_label_set_long_mode(label, LV_LABEL_LONG_WRAP);  // å¤šè¡Œæ—¶æ­£å¸¸æ¢è¡Œï¼ˆæ­¤å¤„å•è¡Œï¼?

    // å­—ä½“ï¼šå¯ç”¨äº† 20 å·å­—å°±ç”¨20ï¼›å¦åˆ™é€€å›žé»˜è®¤å­—ä½“ï¼ˆé»˜è®¤æ˜¯æ­£ä½“ï¼‰
    #if LV_FONT_MONTSERRAT_20
        lv_obj_set_style_text_font(label, &lv_font_montserrat_20, 0);
    #else
        lv_obj_set_style_text_font(label, LV_FONT_DEFAULT, 0);
    #endif

    // æ˜Žç¡®ç¦ç”¨ä»»ä½•å‡ ä½•å˜æ¢ï¼ˆé˜²æ­¢å€¾æ–œ/æ—‹è½¬ï¼?
    lv_obj_set_style_transform_angle(label, 0, 0);
    lv_obj_set_style_transform_skew_x(label, 0, 0);
    lv_obj_set_style_transform_skew_y(label, 0, 0);
    lv_obj_set_style_text_decor(label, LV_TEXT_DECOR_NONE, 0);

    // æ”¾ä¸­é—?
    lv_obj_center(label);

    // é¦–å¸§æ–‡æ¡ˆ
    lv_label_set_text(label, "Waiting for model");

    // 7) å¯åŠ¨æ—¶ä¸»åŠ¨å…¨åˆ?
    lv_obj_invalidate(lv_screen_active());
    lv_refr_now(disp);

    // 8) ä¸»å¾ªçŽ¯ï¼šæ¯?GUI_UPDATE_MS æž„æ–‡æ¡ˆï¼›ä»…å˜åŒ–æ—¶æ‰?set_text
    uint32_t last_update_ms = 0;
    char     last_txt[32] = {0};

    ESP_LOGW(TAG, "LVGL fmt=RGB888; ensure panel is 3B/px (18/24bpp) to avoid slant.");

    while (1) {
        lv_timer_handler();

        uint32_t now = lv_tick_cb();
        if (now - last_update_ms >= GUI_UPDATE_MS) {
            last_update_ms = now;

            char txt[32];
            build_text_from_ml(txt, sizeof(txt));

            if (strcmp(last_txt, txt) != 0) {
                lv_label_set_text(label, txt);       // â†?å”¯ä¸€ä¿®æ”¹ UI æ–‡æœ¬çš„åœ°æ–?
                strncpy(last_txt, txt, sizeof(last_txt) - 1);
                last_txt[sizeof(last_txt) - 1] = '\0';
            }
        }

        vTaskDelay(pdMS_TO_TICKS(10));
    }
}

esp_err_t app_gui_start(void)
{
    static bool started = false;
    if (started) return ESP_OK;
    started = true;

    BaseType_t ok = xTaskCreate(gui_task, "gui", 8192, NULL, 5, NULL);
    return ok == pdPASS ? ESP_OK : ESP_FAIL;
}

